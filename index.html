<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FoodLoop — ЛК ресторана</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; margin: 0; padding: 20px; background: #0f1226; color: #e8eefc; }
    .wrap { max-width: 860px; margin: 0 auto; }
    h2 { margin: 0 0 14px }
    .card { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); border-radius: 14px; padding: 14px; margin-bottom: 14px }
    label { display:block; font-size: 13px; opacity: .8; margin-top: 8px }
    input, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.05); color:#fff; }
    button { padding: 10px 14px; border:0; border-radius: 10px; background:#4c8cf5; color:#fff; font-weight:700; cursor:pointer }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px }
    .muted { opacity:.7 }
    .list { display:grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)); gap:12px; }
    .offer { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 12px }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>Личный кабинет ресторана</h2>
    <div class="card">
      <div class="muted">После активации аккаунта вы сможете добавлять предложения.</div>
      <div id="restInfo" class="muted"></div>
    </div>

    <div class="card">
      <h3>Новое предложение</h3>
      <label>Название</label>
      <input id="title" placeholder="Например, Набор выпечки" />
      <label>Описание</label>
      <textarea id="desc" rows="3" placeholder="Краткое описание..."></textarea>
      <div class="row">
        <div>
          <label>Цена (₽)</label>
          <input id="price" type="number" step="0.01" placeholder="3.50" />
        </div>
        <div>
          <label>Количество</label>
          <input id="qty" type="number" placeholder="5" />
        </div>
      </div>
      <label>Действует до (ISO, напр. 2025-12-31T20:30:00Z)</label>
      <input id="expires" placeholder="2025-12-31T20:30:00Z" />
      <div style="margin-top:10px"><button id="saveBtn">Сохранить</button></div>
    </div>

    <div class="card">
      <h3>Мои предложения</h3>
      <div id="offers" class="list"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp; tg?.expand?.();
    const urlp = new URLSearchParams(location.search);
    const BACKEND_URL = urlp.get('api') || 'http://localhost:8000';

    let restaurant = null; // {id, name}

    const token = urlp.get('token');
    if (token) {
      fetch(BACKEND_URL + '/verify/' + token).then(r=>r.json()).then(data=>{
        if (data.restaurant_id){
          restaurant = { id: data.restaurant_id, name: data.restaurant_name };
          document.getElementById('restInfo').textContent = 'Аккаунт активирован: ' + restaurant.name + ' (id ' + restaurant.id + ')';
          loadOffers();
        } else {
          document.getElementById('restInfo').textContent = 'Ошибка активации: ' + JSON.stringify(data);
        }
      }).catch(()=>{
        document.getElementById('restInfo').textContent = 'Сервер недоступен';
      });
    }

    function el(id){ return document.getElementById(id) }

    function loadOffers(){
      fetch(BACKEND_URL + '/offers').then(r=>r.json()).then(items=>{
        const wrap = el('offers'); wrap.innerHTML='';
        items.filter(o => !restaurant || o.restaurant === restaurant.name).forEach(o=>{
          const d = document.createElement('div');
          d.className='offer';
          d.innerHTML = '<b>'+o.title+'</b><br>'+ (o.description||'') + '<br><span class="muted">'+o.price+' ₽ • шт: '+o.quantity+'</span>';
          wrap.appendChild(d);
        });
      });
    }

    el('saveBtn').onclick = () => {
      if (!restaurant){ alert('Сначала активируйте аккаунт по ссылке из бота.'); return; }
      const payload = {
        restaurant_id: restaurant.id,
        title: el('title').value,
        description: el('desc').value,
        price: parseFloat(el('price').value),
        quantity: parseInt(el('qty').value),
        expires_at: el('expires').value
      };
      fetch(BACKEND_URL + '/offers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(r=>r.json()).then(res=>{
        if (res.offer_id){ alert('Сохранено ✅'); loadOffers(); }
        else { alert('Ошибка: '+JSON.stringify(res)); }
      }).catch(e=> alert('Ошибка сети: '+e));
    };
  </script>
</body>
</html>
