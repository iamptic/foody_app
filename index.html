<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Foody ‚Äî –õ–ö —Ä–µ—Å—Ç–æ—Ä–∞–Ω–∞</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Inter, Arial; margin: 0; padding: 20px; background: #0f1226; color: #e8eefc; }
    .wrap { max-width: 860px; margin: 0 auto; }
    h2 { margin: 0 0 14px }
    .card { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); border-radius: 14px; padding: 14px; margin-bottom: 14px }
    label { display:block; font-size: 13px; opacity: .8; margin-top: 8px }
    input, textarea { width:100%; padding:10px; border-radius:10px; border:1px solid rgba(255,255,255,.2); background: rgba(255,255,255,.05); color:#fff; }
    button { padding: 10px 14px; border:0; border-radius: 10px; background:#4c8cf5; color:#fff; font-weight:700; cursor:pointer }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:10px }
    .muted { opacity:.7 }
    .list { display:grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap:12px; }
    .offer { background: rgba(255,255,255,.06); border: 1px solid rgba(255,255,255,.12); border-radius: 12px; padding: 12px }
    .actions { display:flex; gap:8px; margin-top:8px}
    .ghost { background: transparent; border:1px solid rgba(255,255,255,.2); color:#fff }
  </style>
</head>
<body>
  <div class="wrap">
    <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç Foody</h2>
    <div class="card">
      <div class="muted">–ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤—ã —Å–º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–ª—è—Ç—å –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è.</div>
      <div id="restInfo" class="muted"></div>
    </div>

    <div class="card">
      <h3>–ù–æ–≤–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ</h3>
      <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
      <input id="title" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä, –ù–∞–±–æ—Ä –≤—ã–ø–µ—á–∫–∏" />
      <label>–û–ø–∏—Å–∞–Ω–∏–µ</label>
      <textarea id="desc" rows="3" placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ..."></textarea>
      <div class="row">
        <div>
          <label>–¶–µ–Ω–∞ (‚ÇΩ)</label>
          <input id="price" type="number" step="0.01" placeholder="3.50" />
        </div>
        <div>
          <label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</label>
          <input id="qty" type="number" placeholder="5" />
        </div>
      </div>
      <label>–î–µ–π—Å—Ç–≤—É–µ—Ç –¥–æ (ISO, –Ω–∞–ø—Ä. 2025-12-31T20:30:00+07:00). –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî —Å–µ–≥–æ–¥–Ω—è 23:59 –ø–æ –¢–æ–º—Å–∫—É</label>
      <input id="expires" placeholder="" />
      <div style="margin-top:10px"><button id="saveBtn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button></div>
    </div>

    <div class="card">
      <h3>–ú–æ–∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è</h3>
      <div id="offers" class="list"></div>
    </div>
  </div>

  <script>
    const tg = window.Telegram?.WebApp; tg?.expand?.();
    const urlp = new URLSearchParams(location.search);
    const BACKEND_URL = urlp.get('api') || 'http://localhost:8000';

    let restaurant = null; // {id, name}

    const token = urlp.get('token');
    if (token) {
      fetch(BACKEND_URL + '/verify/' + token).then(r=>r.json()).then(data=>{
        if (data.restaurant_id){
          restaurant = { id: data.restaurant_id, name: data.restaurant_name };
          document.getElementById('restInfo').textContent = '–ê–∫–∫–∞—É–Ω—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: ' + restaurant.name + ' (id ' + restaurant.id + ')';
          loadOffers();
        } else {
          document.getElementById('restInfo').textContent = '–û—à–∏–±–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏: ' + JSON.stringify(data);
        }
      }).catch(()=>{
        document.getElementById('restInfo').textContent = '–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω';
      });
    }

    function el(id){ return document.getElementById(id) }

    function loadOffers(){
      fetch(BACKEND_URL + '/offers').then(r=>r.json()).then(items=>{
        const wrap = el('offers'); wrap.innerHTML='';
        items.filter(o => !restaurant || o.restaurant === restaurant.name).forEach(o=>{
          const d = document.createElement('div');
          d.className='offer';
          d.innerHTML = '<b>'+o.title+'</b><br>'
            + (o.description||'') 
            + '<br><span class="muted">'+o.price+' ‚ÇΩ ‚Ä¢ —à—Ç: '+o.quantity+'</span>'
            + '<div class="actions">'
            +   '<button class="ghost" data-edit="'+o.id+'">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>'
            +   '<button class="ghost" data-del="'+o.id+'">–£–¥–∞–ª–∏—Ç—å</button>'
            + '</div>';
          wrap.appendChild(d);
        });

        // handlers
        wrap.querySelectorAll('[data-edit]').forEach(btn => {
          btn.onclick = () => editOffer(Number(btn.dataset.edit));
        });
        wrap.querySelectorAll('[data-del]').forEach(btn => {
          btn.onclick = () => deleteOffer(Number(btn.dataset.del));
        });
      });
    }

    el('saveBtn').onclick = () => {
      if (!restaurant){ alert('–°–Ω–∞—á–∞–ª–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–π—Ç–µ –∞–∫–∫–∞—É–Ω—Ç –ø–æ —Å—Å—ã–ª–∫–µ –∏–∑ –±–æ—Ç–∞.'); return; }
      const payload = {
        restaurant_id: restaurant.id,
        title: el('title').value,
        description: el('desc').value,
        price: parseFloat(el('price').value),
        quantity: parseInt(el('qty').value),
        expires_at: el('expires').value || null
      };
      fetch(BACKEND_URL + '/offers', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      }).then(r=>r.json()).then(res=>{
        if (res.offer_id){ alert('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ'); loadOffers(); }
        else { alert('–û—à–∏–±–∫–∞: '+JSON.stringify(res)); }
      }).catch(e=> alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: '+e));
    };

    function editOffer(id){
      const price = prompt('–ù–æ–≤–∞—è —Ü–µ–Ω–∞ (‚ÇΩ):');
      const qty = prompt('–ù–æ–≤–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ (—à—Ç):');
      const patch = {};
      if (price) patch.price = parseFloat(price);
      if (qty) patch.quantity = parseInt(qty);
      if (!Object.keys(patch).length) return;
      fetch(BACKEND_URL + '/offers/' + id, {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(patch)
      }).then(r=>r.json()).then(res=>{
        if (res.offer_id){ alert('–û–±–Ω–æ–≤–ª–µ–Ω–æ ‚úÖ'); loadOffers(); }
        else { alert('–û—à–∏–±–∫–∞: '+JSON.stringify(res)); }
      }).catch(e=> alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: '+e));
    }

    function deleteOffer(id){
      if (!confirm('–£–¥–∞–ª–∏—Ç—å –æ—Ñ—Ñ–µ—Ä #' + id + '?')) return;
      fetch(BACKEND_URL + '/offers/' + id, { method: 'DELETE' })
      .then(r=>r.json())
      .then(res=>{
        if (res.status === 'deleted'){ alert('–£–¥–∞–ª–µ–Ω–æ üóëÔ∏è'); loadOffers(); }
        else { alert('–û—à–∏–±–∫–∞: '+JSON.stringify(res)); }
      }).catch(e=> alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: '+e));
    }
  </script>
</body>
</html>
